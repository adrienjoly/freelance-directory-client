<!doctype html>
<html>
  <body>
    <div id="logged" style="display: none;">
      <button id="btnFetchAll">List all contacts</button>
      <button id="btnBackup">Backup contacts</button>
      <form id="search">
        Search contact:
        <input id="query">
        <input type="submit" value="OK">
      </form>
      <form id="fetch">
        Display contact by id:
        <input id="fetchContactId" value="0">
        <input type="submit" value="OK">
      </form>
      <form id="append">
        Append note to contact:
        <input id="appendContactId" value="0">
        <input type="submit" value="OK">
      </form>
    </div>
    <pre id="results">
    </pre>

    <button id="btnRegisterProtocol">Register protocol</button>
    <a href="web+fdupdate:scott@whyd.com/github.com/adrienjoly/freelance-directory-client/commit/58525a4a026f25d3a116eef2f0e73ed62c81da10">Test custom protocol handler</a>

    <script src="https://apis.google.com/js/client.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="contacts.js"></script>
    <script>

    window.onload = function() {

      document.getElementById('btnRegisterProtocol').onclick = function() {
        var host = window.location.href; //.split('/').slice(0, 3).join('/');
        console.log('host', host);
        navigator.registerProtocolHandler('web+fdupdate', host + '?fdupdate=%s', 'Freelance Directory Update');
      }

      auth(function(err, token){

        var fdupdate = decodeURIComponent(window.location.href.split(/[\?\&]fdupdate=/)[1] || '');
        if (fdupdate) {
          var RE_FDUPDATE = /^[^\:]+\:([^\/]+)\/(.+)$/;
          var parts = RE_FDUPDATE.exec(fdupdate);
          var email = parts[1];
          var updUrl = parts[2]
            .replace('github.com', 'https://api.github.com/repos')
            .replace('/commit/', '/commits/')
            .replace(/\/$/, ''); // remove trailing slash
          console.log(updUrl, '...');
          query({
            url: updUrl,
            dataType: 'jsonp'
          }, function(json) {
            console.log('=> github json:', json);
            var dataUrl = json.data.files[0].contents_url;
            query(dataUrl, function(json) {
              //console.log('=> content:', json);
              console.log('=> update data:', atob(json.content)); // decode base64 string
            });
          });
        }

        document.getElementById('logged').style.display = 'block';

        document.getElementById('btnFetchAll').onclick = fetchAndDisplay.bind(null, token);

        document.getElementById('btnBackup').onclick = backupAndDisplay.bind(null, token);

        document.getElementById('fetch').onsubmit = function(evt) {
          evt.preventDefault();
          var contactId = document.getElementById('fetchContactId').value;
          fetchUser(token, contactId, function(err, res){
            console.log(arguments);
            appendEntries(document.getElementById('results'), [ res.entry ]);
          });
        };

        document.getElementById('append').onsubmit = function(evt) {
          evt.preventDefault();
          var contactId = document.getElementById('appendContactId').value;
          appendCoucouToUser(token, contactId);
        };

        document.getElementById('search').onsubmit = function(evt) {
          evt.preventDefault();
          var q = document.getElementById('query').value;
          searchAndDisplay(token, q);
        };
      });
    };
    </script>
  </body>
</html>
