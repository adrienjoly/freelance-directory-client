<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Freelance Directory Update...</title>
</head>
<body>
  <h1>Looking for update commit...</h1>
  <pre id="results">
  </pre>
  <script src="https://apis.google.com/js/client.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
  <script src="contacts.js"></script>
  <script>
  window.onload = function() {
    var fdupdate = decodeURIComponent(window.location.href.split(/[\?\&]fdupdate=/)[1] || '');
    console.log('fdupdate parameter:', fdupdate);
    if (fdupdate) {
      var RE_FDUPDATE = /^[^\:]+\:([^\/]+)\/(.+)$/;
      var parts = RE_FDUPDATE.exec(fdupdate);
      var email = parts[1];
      var updUrl = parts[2]
        .replace('github.com', 'https://api.github.com/repos')
        .replace('/commit/', '/commits/')
        .replace(/\/$/, ''); // remove trailing slash
      console.log('fetching', updUrl, '...');
      $('h1').text('Fetching commit...');
      query({
        url: updUrl,
        dataType: 'jsonp'
      }, function(json) {
        console.log('=> github json:', json);
        var dataUrl = json.data.files[0].contents_url;
        console.log('fetching', dataUrl, '...');
        $('h1').text('Fetching update...');
        query(dataUrl, function(json) {
          var profileInfo = atob(json.content);
          console.log('=> commit content:', json);
          $('h1').text('Store update?');
          $('pre').text(profileInfo);
        });
      });
      // TODO: if user accepts => store update in corresponding google contact
      /*
      auth(function(err, token){
        document.getElementById('fetch').onsubmit = function(evt) {
          evt.preventDefault();
          var contactId = document.getElementById('fetchContactId').value;
          fetchUser(token, contactId, function(err, res){
            console.log(arguments);
            appendEntries(document.getElementById('results'), [ res.entry ]);
          });
        };

        document.getElementById('append').onsubmit = function(evt) {
          evt.preventDefault();
          var contactId = document.getElementById('appendContactId').value;
          appendCoucouToUser(token, contactId);
        };
      });
      */
    }
  };
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-1858235-20', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
